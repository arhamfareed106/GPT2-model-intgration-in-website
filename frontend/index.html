<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zoid GPT - Experimental Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .zoid-scrollbar {
            scrollbar-width: thin;
            scrollbar-color: #cbd5e1 #f1f5f9;
        }

        .zoid-scrollbar::-webkit-scrollbar {
            width: 8px;
        }

        .zoid-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        .zoid-scrollbar::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 4px;
        }

        .dark .zoid-scrollbar {
            scrollbar-color: #475569 #1e293b;
        }

        .dark .zoid-scrollbar::-webkit-scrollbar-track {
            background: #1e293b;
        }

        .dark .zoid-scrollbar::-webkit-scrollbar-thumb {
            background-color: #475569;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 h-screen flex flex-col">
    <!-- Header -->
    <header class="bg-white dark:bg-gray-800 shadow-sm">
        <div class="max-w-4xl mx-auto px-4 py-4 flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <div class="bg-blue-500 rounded-full p-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2  0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                    </svg>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-gray-900 dark:text-white">Zoid GPT</h1>
                    <p class="text-xs text-gray-500 dark:text-gray-400">Experimental Chat</p>
                </div>
            </div>
            
            <div class="flex items-center space-x-4">
                <!-- Server Status Indicator -->
                <div class="flex items-center">
                    <span class="inline-block w-3 h-3 rounded-full mr-2 bg-gray-400" id="server-status-indicator"></span>
                    <span class="text-sm text-gray-600 dark:text-gray-300" id="server-status-text">Checking...</span>
                </div>
                
                <!-- Dark Mode Toggle -->
                <button id="dark-mode-toggle" class="p-2 rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors" aria-label="Toggle dark mode">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z" />
                    </svg>
                </button>
                
                <!-- Clear Chat Button -->
                <button id="clear-chat" class="px-3 py-2 text-sm rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                    Clear Chat
                </button>
            </div>
        </div>
    </header>

    <!-- Main Chat Area -->
    <main class="flex-1 overflow-hidden flex flex-col">
        <!-- Chat Window -->
        <div class="flex-1 overflow-y-auto p-4 zoid-scrollbar" id="chat-window">
            <div class="max-w-4xl mx-auto space-y-6" id="chat-container">
                <div class="flex flex-col items-center justify-center h-full text-center py-12" id="welcome-message">
                    <div class="bg-blue-100 dark:bg-blue-900/30 rounded-full p-4 mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-blue-500 dark:text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                        </svg>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">Welcome to Zoid GPT</h3>
                    <p class="text-gray-600 dark:text-gray-400 max-w-md">
                        Start a conversation by typing a message below. I'm here to help with any questions you might have!
                    </p>
                </div>
            </div>
        </div>

        <!-- Chat Input -->
        <div class="border-t border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-4">
            <form id="chat-form" class="max-w-4xl mx-auto">
                <div class="flex space-x-2">
                    <div class="flex-1 relative">
                        <textarea
                            id="message-input"
                            placeholder="Type your message..."
                            class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-2xl focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white resize-none"
                            rows="1"
                        ></textarea>
                    </div>
                    <button
                        type="submit"
                        id="send-button"
                        class="self-end h-12 w-12 flex items-center justify-center rounded-full bg-blue-500 hover:bg-blue-600 transition-colors"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" />
                        </svg>
                    </button>
                </div>
                <div class="text-xs text-center text-gray-500 dark:text-gray-400 mt-2">
                    Press Enter to send, Shift+Enter for new line
                </div>
            </form>
        </div>
    </main>

    <script>
        // Configuration
        const API_BASE = "http://localhost:5000";
        
        // DOM Elements
        const chatWindow = document.getElementById('chat-window');
        const chatContainer = document.getElementById('chat-container');
        const chatForm = document.getElementById('chat-form');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const clearChatButton = document.getElementById('clear-chat');
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const serverStatusIndicator = document.getElementById('server-status-indicator');
        const serverStatusText = document.getElementById('server-status-text');
        const welcomeMessage = document.getElementById('welcome-message');
        
        // State
        let messages = [];
        let isServerOnline = false;
        let isLoading = false;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            console.log("Initializing Zoid GPT frontend...");
            // Check server health
            checkServerHealth();
            
            // Set up periodic health checks
            setInterval(checkServerHealth, 30000);
            
            // Set up event listeners
            chatForm.addEventListener('submit', handleMessageSubmit);
            clearChatButton.addEventListener('click', clearChat);
            darkModeToggle.addEventListener('click', toggleDarkMode);
            
            // Load dark mode preference
            if (localStorage.getItem('darkMode') === 'true') {
                document.documentElement.classList.add('dark');
            }
        });
        
        // Functions
        async function checkServerHealth() {
            try {
                console.log("Checking server health...");
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                isServerOnline = data.status === "ok";
                
                // Update UI
                serverStatusIndicator.className = `inline-block w-3 h-3 rounded-full mr-2 ${isServerOnline ? 'bg-green-500' : 'bg-red-500'}`;
                serverStatusText.textContent = isServerOnline ? 'Online' : 'Offline';
                messageInput.placeholder = isServerOnline ? 'Type your message...' : 'Server is offline...';
                
                console.log("Server status:", isServerOnline ? 'Online' : 'Offline');
            } catch (error) {
                console.error("Server health check failed:", error);
                isServerOnline = false;
                serverStatusIndicator.className = 'inline-block w-3 h-3 rounded-full mr-2 bg-red-500';
                serverStatusText.textContent = 'Offline';
                messageInput.placeholder = 'Server is offline...';
            }
        }
        
        function handleMessageSubmit(event) {
            event.preventDefault();
            const prompt = messageInput.value.trim();
            
            console.log("Sending message:", prompt);
            
            if (prompt && isServerOnline && !isLoading) {
                sendMessage(prompt);
                messageInput.value = '';
            }
        }
        
        async function sendMessage(prompt) {
            // Add user message to chat
            const userMessage = {
                id: Date.now(),
                text: prompt,
                sender: 'user',
                timestamp: new Date()
            };
            
            addMessageToChat(userMessage);
            showLoadingIndicator();
            
            try {
                // Call the backend API
                const response = await fetch(`${API_BASE}/generate`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ prompt })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log("Received response:", data);
                
                // Add AI response to chat
                const aiMessage = {
                    id: Date.now() + 1,
                    text: data.reply || data.response || "No response received",
                    sender: 'ai',
                    timestamp: new Date()
                };
                
                hideLoadingIndicator();
                addMessageToChat(aiMessage);
            } catch (error) {
                console.error("Error sending message:", error);
                // Add error message to chat
                const errorMessage = {
                    id: Date.now() + 1,
                    text: "Sorry, I encountered an error processing your request.",
                    sender: 'ai',
                    timestamp: new Date(),
                    isError: true
                };
                
                hideLoadingIndicator();
                addMessageToChat(errorMessage);
            }
        }
        
        function addMessageToChat(message) {
            console.log("Adding message to chat:", message);
            // Remove welcome message if it's the first message
            if (messages.length === 0) {
                welcomeMessage.remove();
            }
            
            messages.push(message);
            
            // Create message element
            const messageElement = document.createElement('div');
            messageElement.className = `flex ${message.sender === 'user' ? 'justify-end' : 'justify-start'}`;
            
            const messageContent = document.createElement('div');
            messageContent.className = `max-w-[80%] rounded-2xl px-4 py-3 ${
                message.sender === 'user' 
                    ? 'bg-blue-500 text-white rounded-br-none' 
                    : message.isError
                        ? 'bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300 rounded-bl-none'
                        : 'bg-gray-100 dark:bg-gray-800 text-gray-800 dark:text-gray-200 rounded-bl-none'
            }`;
            
            messageContent.innerHTML = `
                <div class="whitespace-pre-wrap">${message.text}</div>
                <div class="${message.sender === 'user' ? 'text-blue-100' : message.isError ? 'text-red-500 dark:text-red-400' : 'text-gray-500 dark:text-gray-400'} text-xs mt-1">
                    ${formatTime(message.timestamp)}
                </div>
            `;
            
            messageElement.appendChild(messageContent);
            
            // Append to chat container
            chatContainer.appendChild(messageElement);
            
            // Scroll to bottom
            scrollToBottom();
        }
        
        function showLoadingIndicator() {
            isLoading = true;
            const loadingElement = document.createElement('div');
            loadingElement.className = 'flex justify-start';
            loadingElement.id = 'loading-indicator';
            loadingElement.innerHTML = `
                <div class="bg-gray-100 dark:bg-gray-800 text-gray-800 dark:text-gray-200 rounded-2xl rounded-bl-none px-4 py-3">
                    <div class="flex items-center">
                        <div class="flex space-x-1">
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s;"></div>
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.4s;"></div>
                        </div>
                        <span class="ml-2 text-gray-500 dark:text-gray-400">Zoid is thinking...</span>
                    </div>
                </div>
            `;
            
            chatContainer.appendChild(loadingElement);
            scrollToBottom();
        }
        
        function hideLoadingIndicator() {
            isLoading = false;
            const loadingElement = document.getElementById('loading-indicator');
            if (loadingElement) {
                loadingElement.remove();
            }
        }
        
        function clearChat() {
            messages = [];
            chatContainer.innerHTML = '';
            
            // Add welcome message back
            const welcomeDiv = document.createElement('div');
            welcomeDiv.className = 'flex flex-col items-center justify-center h-full text-center py-12';
            welcomeDiv.id = 'welcome-message';
            welcomeDiv.innerHTML = `
                <div class="bg-blue-100 dark:bg-blue-900/30 rounded-full p-4 mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-blue-500 dark:text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                    </svg>
                </div>
                <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">Welcome to Zoid GPT</h3>
                <p class="text-gray-600 dark:text-gray-400 max-w-md">
                    Start a conversation by typing a message below. I'm here to help with any questions you might have!
                </p>
            `;
            chatContainer.appendChild(welcomeDiv);
        }
        
        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('darkMode', document.documentElement.classList.contains('dark'));
        }
        
        function formatTime(date) {
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }
        
        function scrollToBottom() {
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }
    </script>
</body>
</html>